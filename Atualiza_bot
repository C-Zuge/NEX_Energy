from bs4 import BeautifulSoup 
import requests
import time 

print('Digite a UC: ')
uc = str(input())
senha = 'ie'+ uc
data = {'UC':uc, 'Senha':senha}
url = 'http://agencia.ienergia.com.br:8085/'
tempo = 0
Comandos = {
        'atualiza',
        'sair',
        'baixar',
        'comandos',
        'uc'
        }
Crawling_data = {
        }

def get_boleto_num(lista):
    boleto = str(lista[3]).split('=')
    boleto = str(boleto[2]).split(' ')
    boleto = str(boleto[0]).split('"')
    return boleto[1]

def atualiza_pagina_inicial(link,param):
    page = requests.post(link, param)
    soup = BeautifulSoup(page.text,'html.parser')
    pg = soup.find_all(class_='content differ')
    data,boleto = get_data(pg)
    data_list = add_hist(data)
    vencimento = data_list[3]
    valor_fatura = data_list[4]
    open('Atualiza_bot.html','a+').write(str('<br />'))
    open('Atualiza_bot.html','a+').write(str(vencimento))
    open('Atualiza_bot.html','a+').write(str('<br />'))
    open('Atualiza_bot.html','a+').write(str(valor_fatura))
    open('Atualiza_bot.html','a+').write(str('<br />'))
    return data_list,boleto


def get_data(html):
    html_data = []
    for td in html:
        tds = td.find_all('td')
    for i in range(len(tds)):
         html_data += (tds[i])
    boleto = get_boleto_num(html_data)
    return html_data,boleto

def add_hist(param):
    data_list = []  
    for i in range(len(param)):
        data_list += str(param[i]).split('<')
    return data_list
    

while True :
    if (tempo == 0):
        data_list,boleto = atualiza_pagina_inicial(url,data)
        tempo_before = time.localtime().tm_min
        print('Dados Atualizados com Sucesso!',tempo_before)
    elif (tempo_before >= tempo + 1):
        data_list,boleto = atualiza_pagina_inicial(url,data)
        print('Dados Atualizados com Sucesso!')
    else:
        print('\nDigite COMANDOS para ver os comandos possiveis \n')
        print('Digite o comando: ')
        com = str(input()).lower()
        if(com in Comandos):
            if (com=='sair'):
                break
            elif (com=='atualiza'):
                data_list,boleto = atualiza_pagina_inicial(url,data)
                print('Dados Atualizados com Sucesso!')
            elif(com=='comandos'):
                print(Comandos)
            elif(com=='uc'):
                print('Digite a UC atualizada: ')
                uc = input()
                data = {'UC':uc, 'Senha':senha}
                print('Atualizado!')
            else:
                pass
                url_boleto = 'http://agencia.ienergia.com.br:8085/Faturas/EmiteFatura/'+boleto
                page_boleto = requests.post(url_boleto,data)
                soup_boleto = BeautifulSoup(page_boleto.text,'html.parser')
                open('boleto.html','w').write(str(soup_boleto))
    
        else:
            print('comando errado irmao \n')
            break
    tempo = time.localtime().tm_min
        
                
    
    
    
